<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Codici Amico - Community Telegram</title>
    <!-- Carica Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carica React e React DOM -->
    <!-- NB: Usiamo la versione di produzione per un caricamento più veloce e stabile -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Configurazione Tailwind per il font Inter -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            colors: {
                // Definisco colori custom per consistenza
                'primary-indigo': '#4f46e5', // indigo-600
                'secondary-cyan': '#06b6d4', // cyan-500
            }
          },
        }
      }
    </script>
    <style>
        /* Imposta il font Inter come predefinito */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        /* Animazione per il focus sugli elementi principali */
        @keyframes pulse-once {
            0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); }
            100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
        }
        .animate-pulse-once {
            animation: pulse-once 1.5s ease-out 1;
        }

        /* Stile specifico per il codice/link quando è un link cliccabile */
        .code-link {
            text-decoration: underline;
            color: #4f46e5; /* primary-indigo */
        }
        .code-link:hover {
            color: #3730a3; /* indigo-800 */
        }

        /* Stile per il popup modale */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem; /* rounded-xl */
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- IL CODICE REACT CONVERTITO IN JS NATÌVO -->
    <script>
// Usiamo i namespace React e ReactDOM come variabili globali
const { useState, useEffect, useMemo, useCallback } = React;
const ReactDOM = window.ReactDOM;

// -------------------------------------------------------------------------------------
// Definizione delle icone SVG (Inline)
// -------------------------------------------------------------------------------------
const ZapIcon = ({ className = "w-6 h-6" }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className },
    React.createElement("polygon", { points: "13 2 3 14 12 14 11 22 21 10 12 10 13 2" })
);
const CopyIcon = ({ className = "w-5 h-5" }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className },
    React.createElement("rect", { width: "13", height: "13", x: "9", y: "9", rx: "2", ry: "2" }),
    React.createElement("path", { d: "M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" })
);
const LinkIcon = ({ className = "w-5 h-5" }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className },
    React.createElement("path", { d: "M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.74 1.74" }),
    React.createElement("path", { d: "M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" })
);
const DollarSignIcon = ({ className = "w-4 h-4" }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className },
    React.createElement("line", { x1: "12", y1: "1", x2: "12", y2: "23" }),
    React.createElement("path", { d: "M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" })
);
const AlertCircleIcon = ({ className = "w-5 h-5" }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className },
    React.createElement("circle", { cx: "12", cy: "12", r: "10" }),
    React.createElement("line", { x1: "12", y1: "8", x2: "12", y2: "12" }),
    React.createElement("line", { x1: "12", y1: "16", x2: "12.01", y2: "16" })
);
const CheckIcon = ({ className = "w-5 h-5" }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className },
    React.createElement("polyline", { points: "20 6 9 17 4 12" })
);
const CalendarIcon = ({ className = "w-4 h-4" }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className },
    React.createElement("rect", { x: "3", y: "4", width: "18", height: "18", rx: "2", ry: "2" }),
    React.createElement("line", { x1: "16", y1: "2", x2: "16", y2: "6" }),
    React.createElement("line", { x1: "8", y1: "2", x2: "8", y2: "6" }),
    React.createElement("line", { x1: "3", y1: "10", x2: "21", y2: "10" })
);
const SendIcon = ({ className = "w-5 h-5" }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className },
    React.createElement("line", { x1: "22", y1: "2", x2: "11", y2: "13" }),
    React.createElement("polygon", { points: "22 2 15 22 11 13 2 9 22 2" })
);
const XIcon = ({ className = "w-5 h-5" }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className },
    React.createElement("line", { x1: "18", y1: "6", x2: "6", y2: "18" }),
    React.createElement("line", { x1: "6", y1: "6", x2: "18", y2: "18" })
);
// -------------------------------------------------------------------------------------


const SHEET_ID = '1CtQ3E_nUmxKNipJNrirwlYwmRRzmxs9JitFTRIdvhU0';
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;

const COL_INDEX = {
    BRAND: 1,       // Fornitore
    CODE: 2,        // Codice o Link
    VALUE: 3,       // Sconto
    TELEGRAM: 4,    // Contatto telegram
    EXPIRY: 5,      // Scadenza
    DESCRIPTION: 6  // Note
};

/**
 * Controlla lo stato di scadenza di un codice.
 * @param {string} expiryDateStr - La stringa della data di scadenza (es. "31/12/2025").
 * @returns {{status: string, isExpired: boolean, display: string}} - Stato e data formattata.
 */
const checkExpiryStatus = (expiryDateStr) => {
    if (!expiryDateStr || expiryDateStr.toLowerCase().includes('nessuna scadenza') || expiryDateStr.trim() === '') {
        return { status: 'Attivo', isExpired: false, display: 'Nessuna' };
    }
    
    const parts = expiryDateStr.split('/');
    if (parts.length !== 3) {
        return { status: 'Attivo', isExpired: false, display: expiryDateStr };
    }
    
    // Parses date in D/M/YYYY format
    const [day, month, year] = parts.map(p => parseInt(p.trim(), 10));
    // The month index is 0-based in JavaScript Date (January is 0)
    const expiryDate = new Date(year, month - 1, day, 23, 59, 59);
    const today = new Date();

    if (expiryDate < today) {
        return { status: 'Scaduto', isExpired: true, display: expiryDateStr };
    } else {
        return { status: 'Attivo', isExpired: false, display: expiryDateStr };
    }
};

/**
 * Controlla se una stringa è un URL valido (inizia con http(s)://).
 * @param {string} str - La stringa da controllare.
 * @returns {boolean} - True se è un link.
 */
const isUrl = (str) => {
    return str && (str.startsWith('http://') || str.startsWith('https://'));
};


// Componente per visualizzare i dettagli
const DetailCard = ({ icon: Icon, title, value, colorClass = 'text-slate-600', isExpired = false }) => {
    const cardClass = `p-4 rounded-lg border shadow-sm ${isExpired ? 'bg-red-50 border-red-200' : 'bg-white border-slate-100'} flex flex-col items-center`;
    const valueClass = `text-lg font-bold mt-1 ${isExpired ? 'text-red-600' : 'text-slate-800'}`;

    return React.createElement('div', { className: cardClass },
        React.createElement('div', { className: 'flex items-center space-x-2 mb-1' },
            React.createElement(Icon, { className: `w-4 h-4 ${colorClass}` }),
            React.createElement('p', { className: 'text-xs uppercase text-slate-400 font-semibold' }, title)
        ),
        React.createElement('p', { className: valueClass }, value)
    );
};

// Componente Modale per Termini/Privacy
const Modal = ({ title, content, onClose }) => {
    return ReactDOM.createPortal(
        React.createElement('div', { className: "modal-overlay", onClick: onClose },
            React.createElement('div', { 
                className: "modal-content transition-all duration-300 transform scale-100", 
                onClick: (e) => e.stopPropagation() // Evita che il click sul contenuto chiuda il modale
            },
                React.createElement('div', { className: "flex justify-between items-start border-b pb-3 mb-4" },
                    React.createElement('h2', { className: "text-xl font-bold text-slate-800" }, title),
                    React.createElement('button', { 
                        onClick: onClose,
                        className: "p-1 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-colors"
                    }, 
                        React.createElement(XIcon, null)
                    )
                ),
                React.createElement('div', { className: "text-sm text-slate-600 leading-relaxed space-y-4" },
                    content() // Esegue la funzione per il contenuto
                )
            )
        ),
        document.body
    );
};

// Contenuto per Termini e Condizioni AGGIORNATO
const TermsContent = () => React.createElement(React.Fragment, null,
    React.createElement('p', null, 
        React.createElement('strong', null, "1. Accettazione dei Termini"),
        React.createElement('br', null),
        "Utilizzando questo sito accetti di essere vincolato da questi termini e condizioni d'uso. Se non accetti questi termini, ti preghiamo di non utilizzare il nostro sito web.",
    ),
    React.createElement('p', null, 
        React.createElement('strong', null, "2. Scopo del Servizio"),
        React.createElement('br', null),
        "Questa applicazione web è un semplice generatore casuale di codici amico (codici e/o link) per sconti luce e gas, forniti volontariamente dai membri della community Telegram.",
    ),
    React.createElement('p', null, 
        React.createElement('strong', null, "3. Uso Appropriato"),
        React.createElement('br', null),
        "Gli utenti si impegnano a:",
        React.createElement('ul', { className: "list-disc pl-5 mt-1 space-y-1" },
            React.createElement('li', null, "Utilizzare il servizio solo per scopi legali."),
            React.createElement('li', null, "Non tentare di danneggiare o compromettere la sicurezza del sito."),
            React.createElement('li', null, "Non utilizzare il servizio per attività commerciali.")
        )
    ),
    React.createElement('p', null, 
        React.createElement('strong', null, "4. Limitazione di Responsabilità"),
        React.createElement('br', null),
        "I codici sono forniti 'così come sono'. Non garantiamo l'accuratezza, la validità o la scadenza dei codici. L'uso dei codici è a rischio esclusivo dell'utente e non ci assumiamo alcuna responsabilità per eventuali sconti mancati o problemi con i fornitori di energia.",
    ),
    React.createElement('p', null, 
        React.createElement('strong', null, "5. Modifiche"),
        React.createElement('br', null),
        "Ci riserviamo il diritto di modificare o interrompere il servizio in qualsiasi momento senza preavviso.",
    ),
    React.createElement('p', null, 
        React.createElement('strong', null, "6. Contatti"),
        React.createElement('br', null),
        "Per qualsiasi domanda riguardo questi termini, puoi contattarci tramite il canale telegram della community ",
        React.createElement('a', { 
            href: "https://t.me/offertemercatolibero", 
            target: "_blank", 
            rel: "noopener noreferrer", 
            className: "font-medium text-primary-indigo hover:underline" 
        }, "https://t.me/offertemercatolibero")
    )
);

// Contenuto per Informativa sulla Privacy
const PrivacyContent = () => React.createElement(React.Fragment, null,
    React.createElement('p', null, 
        React.createElement('strong', null, "Non Vengono Raccolti Dati Personali:"),
        " Questo strumento è progettato per la privacy. Non raccogliamo, archiviamo o elaboriamo dati personali degli utenti, indirizzi IP, informazioni sui dispositivi o qualsiasi altra informazione che possa identificare l'utente.",
    ),
    React.createElement('p', null, 
        React.createElement('strong', null, "Nessun Cookie o Tracciamento:"),
        " Questa applicazione non utilizza cookie di tracciamento o di profilazione. Non vengono utilizzati strumenti di analisi esterni per monitorare l'uso dell'applicazione.",
    ),
    React.createElement('p', null, 
        React.createElement('strong', null, "Contenuto Esterno:"),
        " I codici amico potrebbero reindirizzare a siti web esterni (i fornitori di energia), che sono soggetti alle proprie informative sulla privacy e politiche sui cookie.",
    )
);


const App = () => {
    const [data, setData] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [selectedBrand, setSelectedBrand] = useState('');
    const [currentCode, setCurrentCode] = useState(null);
    const [copySuccess, setCopySuccess] = useState(false);
    const [modalType, setModalType] = useState(null); // 'terms' o 'privacy'
    
    const TELEGRAM_LINK = "https://t.me/offertemercatolibero";
    const TELEGRAM_HANDLE = "@offertemercatolibero";

    // Stato per l'animazione di generazione
    const [showCodeAnimation, setShowCodeAnimation] = useState(false);

    // Robust CSV line parser to handle quoted cells
    const parseCSVLine = (text) => {
        const result = [];
        let cell = '';
        let inQuotes = false;

        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            if (char === '"') {
                // Toggle quote state
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                // Delimiter found outside quotes
                // Trim and remove surrounding quotes if present, handle escaped quotes
                result.push(cell.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
                cell = '';
            } else {
                cell += char;
            }
        }
        // Push last cell
        result.push(cell.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
        return result;
    };

    // 1. Fetch Data
    useEffect(() => {
        const fetchData = async () => {
            try {
                setLoading(true);
                const response = await fetch(SHEET_URL, { cache: 'no-store' });
                
                if (!response.ok) {
                    throw new Error(`Errore di connessione (${response.status})`);
                }
                
                const text = await response.text();
                const lines = text.split('\n').filter(line => line.trim() !== '');

                // Assuming the first line is header and skipping it
                if (lines.length < 2) throw new Error("File vuoto o non leggibile.");

                const parsedData = lines.slice(1).map(line => {
                    const cols = parseCSVLine(line);
                    // Minimum column check
                    if (cols.length <= COL_INDEX.DESCRIPTION) return null;
                    
                    return {
                        brand: cols[COL_INDEX.BRAND] || 'N/D',
                        code: cols[COL_INDEX.CODE] || 'N/D',
                        value: cols[COL_INDEX.VALUE] || 'N/D',
                        telegram: cols[COL_INDEX.TELEGRAM] || 'Anonimo',
                        expiry: cols[COL_INDEX.EXPIRY] || '',
                        description: cols[COL_INDEX.DESCRIPTION] || ''
                    };
                }).filter(item => item && item.brand !== 'N/D' && item.code !== 'N/D'); 

                if (parsedData.length === 0) throw new Error("Nessun codice valido trovato.");

                setData(parsedData);
                setLoading(false);
            } catch (err) {
                console.error("Errore caricamento:", err);
                if (err.message.includes('Failed to fetch') || err.message.includes('Failed to read')) {
                    setError("Errore CORS o di Rete. Assicurati che il file sia condiviso con 'Chiunque abbia il link'.");
                } else {
                    setError(err.message);
                }
                setLoading(false);
            }
        };

        fetchData();
    }, []);

    // 2. Compute Brands
    const brands = useMemo(() => {
        // Only show brands that have at least one active (non-expired) code
        const activeBrands = data.filter(item => !checkExpiryStatus(item.expiry).isExpired).map(item => item.brand);
        const uniqueActive = new Set(activeBrands);
        return Array.from(uniqueActive).sort();
        
    }, [data]);

    // 3. Generate Code Logic
    const generateCode = () => {
        if (!selectedBrand) return;

        const pool = data.filter(item => item.brand === selectedBrand);

        if (pool.length === 0) {
            console.error("Nessun codice disponibile per questo fornitore.");
            return;
        }

        // Filtra solo i codici attivi
        const activePool = pool.filter(item => !checkExpiryStatus(item.expiry).isExpired);
        
        if (activePool.length === 0) {
            console.warn("Nessun codice ATTIVO disponibile per questo fornitore.");
            setCurrentCode({
                brand: selectedBrand,
                code: 'Nessun Codice Attivo',
                value: 'N/D',
                telegram: 'Sistema',
                expiry: 'Oggi',
                description: 'Tutti i codici di questo fornitore risultano scaduti.'
            });
            setCopySuccess(false);
            setShowCodeAnimation(true);
            setTimeout(() => setShowCodeAnimation(false), 1500);
            return;
        }
        
        // Seleziona casualmente da quelli attivi
        const selectionPool = activePool;
        const randomIndex = Math.floor(Math.random() * selectionPool.length);
        const selected = selectionPool[randomIndex];
        setCurrentCode(selected);
        setCopySuccess(false);
        
        // Attiva l'animazione
        setShowCodeAnimation(true);
        setTimeout(() => setShowCodeAnimation(false), 1500);
    };

    // 4. Copy to Clipboard
    const copyToClipboard = () => {
        if (!currentCode || currentCode.code === 'Nessun Codice Attivo') return;
        
        // Se è un link, copiamo il link
        const textToCopy = currentCode.code;

        try {
            // Use document.execCommand('copy') for maximum compatibility in iframe environment
            const tempInput = document.createElement('textarea');
            tempInput.value = textToCopy;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            setCopySuccess(true);
            setTimeout(() => setCopySuccess(false), 2000);
        } catch (err) {
            console.error('Impossibile copiare il testo:', err);
        }
    };

    // Funzione principale App (tradotta in JS nativo)
    return React.createElement('div', { className: "min-h-screen bg-slate-50 flex flex-col items-center justify-center p-4 font-sans text-slate-800" },
        
        // Contenitore Principale (Card)
        React.createElement('div', { className: "w-full max-w-lg bg-white shadow-xl rounded-2xl overflow-hidden border border-slate-100 mb-6" },
            
            // Header
            React.createElement('div', { className: "bg-primary-indigo p-8 text-center" },
                // Modifica 1: Titolo su due righe
                React.createElement('h1', { className: "text-3xl font-extrabold text-white mb-2" }, 
                    "Codici Amico",
                    React.createElement('br', null),
                    "per Sconti Luce/Gas"
                ),
                React.createElement('p', { className: "text-indigo-100 opacity-90 text-sm" },
                    // MODIFICA PRECEDENTE: Descrizione più corta e con emoji
                    "❤️ con affetto dalla community Telegram ",
                    React.createElement('a', { 
                        href: TELEGRAM_LINK, 
                        target: "_blank", 
                        rel: "noopener noreferrer", 
                        className: "font-bold underline text-white hover:text-indigo-200 transition-colors" 
                    }, TELEGRAM_HANDLE)
                )
            ),

            React.createElement('div', { className: "p-8 space-y-6" },
                
                // Error Message
                error && React.createElement('div', { className: "bg-red-50 border-l-4 border-red-500 p-4 rounded-lg flex items-start gap-3" },
                    React.createElement(AlertCircleIcon, { className: "w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" }),
                    React.createElement('div', null,
                        React.createElement('h3', { className: "text-sm font-bold text-red-800" }, "Errore Caricamento"),
                        React.createElement('p', { className: "text-xs text-red-600 mt-1" }, error),
                        React.createElement('p', { className: "text-xs text-red-600 mt-2 italic" }, "Suggerimento: Verifica che il link sia accessibile pubblicamente.")
                    )
                ),

                // Loading State
                loading && !error && React.createElement('div', { className: "text-center py-10 space-y-3" },
                    React.createElement('div', { className: "animate-spin rounded-full h-10 w-10 border-b-2 border-primary-indigo mx-auto" }),
                    React.createElement('p', { className: "text-slate-500 text-sm animate-pulse" }, "Caricamento codici in corso...")
                ),

                // Main Content
                !loading && !error && React.createElement(React.Fragment, null,
                    // Controls
                    React.createElement('div', { className: "space-y-4" },
                        // Select Fornitore
                        React.createElement('div', { className: "space-y-2" },
                            React.createElement('div', { className: "relative" },
                                React.createElement('select', { 
                                    value: selectedBrand,
                                    onChange: (e) => {
                                        setSelectedBrand(e.target.value);
                                        setCurrentCode(null);
                                    },
                                    className: "w-full p-3 bg-slate-50 border border-slate-200 rounded-lg appearance-none focus:ring-2 focus:ring-primary-indigo focus:outline-none font-medium text-slate-700 transition-shadow"
                                },
                                    React.createElement('option', { value: "", disabled: true }, "Seleziona il fornitore..."),
                                    brands.map(brand => React.createElement('option', { key: brand, value: brand }, brand))
                                ),
                                React.createElement('div', { className: "absolute right-3 top-3.5 pointer-events-none text-slate-400" },
                                    React.createElement('svg', { className: "w-5 h-5", fill: "none", stroke: "currentColor", viewBox: "0 0 24 24" }, 
                                        React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: "2", d: "M19 9l-7 7-7-7" })
                                    )
                                )
                            )
                        ),

                        // Generate Button
                        React.createElement('button', { 
                            onClick: generateCode,
                            disabled: !selectedBrand,
                            className: `
                                w-full text-lg font-bold py-4 rounded-xl shadow-lg transition-all duration-200 flex items-center justify-center gap-2
                                ${!selectedBrand 
                                    ? 'bg-slate-300 text-slate-500 cursor-not-allowed shadow-none' 
                                    : 'bg-primary-indigo hover:bg-indigo-700 active:scale-[0.98] text-white shadow-primary-indigo/30'}
                            `
                        },
                            React.createElement(ZapIcon, { className: "w-6 h-6" }),
                            "Genera Codice"
                        )
                    ),


                    // 1. AREA DI VISUALIZZAZIONE PRINCIPALE
                    React.createElement('div', { className: `
                        relative border-2 rounded-xl p-6 flex flex-col items-center justify-center text-center min-h-[150px] transition-all duration-300
                        ${currentCode ? 'border-indigo-100 bg-indigo-50/50' : 'border-dashed border-slate-200 bg-slate-50/50'}
                        ${showCodeAnimation && currentCode ? 'animate-pulse-once' : ''}
                    `},
                        !currentCode ? (
                            React.createElement('div', { className: "text-slate-400 flex flex-col items-center" },
                                React.createElement(ZapIcon, { className: "w-10 h-10 mb-3 opacity-20" }),
                                React.createElement('p', { className: "text-sm font-medium" },
                                    !selectedBrand ? 'Seleziona un fornitore per continuare' : 'Premi Genera Codice per scoprire un codice'
                                )
                            )
                        ) : (
                            React.createElement('div', { className: "w-full space-y-3 animate-in fade-in duration-500" },
                                React.createElement('span', { className: "inline-block px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-bold uppercase tracking-wider mb-2" },
                                    currentCode.brand
                                ),
                                
                                // CONTENUTO PRINCIPALE: CODICE O LINK
                                (() => {
                                    const codeText = currentCode.code;
                                    const isCodeLink = isUrl(codeText);
                                    const isExpired = codeText === 'Nessun Codice Attivo';

                                    // Elemento principale del codice/link
                                    const codeElement = React.createElement('h2', { 
                                        className: `text-2xl font-black break-all ${isExpired ? 'text-red-500' : (isCodeLink ? 'text-primary-indigo code-link' : 'text-slate-800')}`
                                    }, codeText);

                                    // L'elemento cliccabile
                                    let clickableElement;

                                    if (isExpired) {
                                        clickableElement = codeElement;
                                    } else if (isCodeLink) {
                                        // Se è un link, lo avvolgiamo in <a>
                                        clickableElement = React.createElement('a', {
                                            href: codeText,
                                            target: "_blank",
                                            rel: "noopener noreferrer",
                                            className: 'flex items-center justify-center gap-2 group cursor-pointer transition-transform duration-100 hover:scale-[1.01]'
                                        },
                                            codeElement,
                                            React.createElement(LinkIcon, { className: "w-5 h-5 text-slate-300 group-hover:text-primary-indigo transition-colors" })
                                        );
                                    } else {
                                        // Se è solo un codice, avvolgiamo l'area con la funzione di copia
                                        clickableElement = React.createElement('div', { 
                                            className: 'flex items-center justify-center gap-2 group cursor-pointer',
                                            onClick: copyToClipboard 
                                        },
                                            codeElement,
                                            copySuccess ? 
                                                React.createElement(CheckIcon, { className: "w-5 h-5 text-green-500" }) : 
                                                React.createElement(CopyIcon, { className: "w-5 h-5 text-slate-300 group-hover:text-primary-indigo transition-colors" })
                                        );
                                    }

                                    return clickableElement;
                                })()
                            )
                        )
                    ),
                    
                    // 2. CARD DETTAGLI AGGIUNTIVI
                    currentCode && React.createElement('div', { className: "space-y-4 pt-4 animate-in fade-in duration-500" },
                        React.createElement('h3', { className: "text-sm font-bold text-slate-700 uppercase tracking-wider border-b border-slate-200 pb-2" }, "Dettagli del Codice"),
                        
                        React.createElement('div', { className: "grid grid-cols-2 gap-3" },
                            // Valore dello Sconto
                            React.createElement(DetailCard, { 
                                icon: DollarSignIcon, 
                                title: "Valore dello Sconto", 
                                value: currentCode.value,
                                colorClass: 'text-green-600'
                            }),
                            
                            // Stato e Scadenza - LOGICA MODIFICATA
                            (() => {
                                // Se non c'è un codice attivo
                                if (currentCode.code === 'Nessun Codice Attivo') {
                                    return React.createElement(DetailCard, { 
                                        icon: AlertCircleIcon, 
                                        title: "Stato / Scadenza", 
                                        value: `Scaduto (Tutti)`,
                                        colorClass: 'text-red-500',
                                        isExpired: true
                                    });
                                }
                                
                                // Per codice generato
                                const { status, isExpired, display } = checkExpiryStatus(currentCode.expiry);
                                
                                // NUOVA LOGICA: Formatta il valore in base allo stato
                                let displayValue = "";
                                if (isExpired) {
                                    displayValue = `Scaduto (${display})`;
                                } else if (display === 'Nessuna') {
                                    displayValue = 'Nessuna Scadenza';
                                } else {
                                    // Formato richiesto: "Attivo fino al --/--/--"
                                    displayValue = `Attivo fino al ${display}`; 
                                }

                                return React.createElement(DetailCard, { 
                                    icon: CalendarIcon, 
                                    title: "Stato / Scadenza", 
                                    value: displayValue, // Usa il nuovo valore
                                    colorClass: isExpired ? 'text-red-500' : 'text-green-500',
                                    isExpired: isExpired
                                });
                            })()
                        )
                    ),
                    
                    // 3. CALL TO ACTION - Community Telegram
                    React.createElement('div', { className: "pt-4" },
                        React.createElement('a', { 
                            href: TELEGRAM_LINK, 
                            target: "_blank", 
                            rel: "noopener noreferrer",
                            className: "w-full flex items-center justify-center gap-3 bg-secondary-cyan hover:bg-cyan-600 text-white font-bold py-3 px-4 rounded-xl shadow-md shadow-secondary-cyan/30 transition-all duration-200 active:scale-[0.99] group"
                        },
                            React.createElement(SendIcon, { className: "w-5 h-5 group-hover:animate-pulse" }),
                            "Unisciti alla Community Telegram"
                        ),
                        // TESTO AGGIORNATO QUI
                        React.createElement('p', { className: "text-center text-xs text-slate-400 mt-2" },
                            "Condividi i tuoi codici e informati sul tema bollette."
                        )
                    )
                )
            )
        ), // Fine Contenitore Principale (Card)

        // Footer con Link per Termini e Privacy
        React.createElement('footer', { className: "w-full max-w-lg text-center mt-4 mb-2" },
            React.createElement('p', { className: "text-xs text-slate-500 space-x-3" },
                // Link Termini
                React.createElement('button', { 
                    onClick: () => setModalType('terms'),
                    className: "text-slate-500 hover:text-primary-indigo transition-colors underline underline-offset-2"
                }, "Termini e Condizioni"),
                
                // Divisore
                React.createElement('span', { className: "text-slate-400" }, "|"),

                // Link Privacy
                React.createElement('button', { 
                    onClick: () => setModalType('privacy'),
                    className: "text-slate-500 hover:text-primary-indigo transition-colors underline underline-offset-2"
                }, "Informativa sulla Privacy")
            )
        ), // Fine Footer
        
        // Modale Condizionale
        modalType && React.createElement(Modal, {
            title: modalType === 'terms' ? 'Termini e Condizioni d\'Uso' : 'Informativa sulla Privacy',
            content: modalType === 'terms' ? TermsContent : PrivacyContent,
            onClose: () => setModalType(null)
        })
    );
}

// Inizializzazione di ReactDOM (rimane invariata)
const container = document.getElementById('root');
const root = ReactDOM.createRoot(container);
root.render(React.createElement(App, null));

    </script>
</body>
</html>
